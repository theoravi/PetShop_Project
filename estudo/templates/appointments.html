{% extends 'base.html' %}
{% block title %}Agendamentos{% endblock %}

{% block content %}
<h2>Meus Agendamentos</h2>
<button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#scheduleModal">
  Novo Agendamento
</button>

<table class="table table-striped">
  <thead>
    <tr>
      <th>Data/Hora</th><th>Serviço</th><th>Pet</th><th>Status</th>
    </tr>
  </thead>
  <tbody>
    {% for appt in appointments %}
      <tr>
        <td>{{ appt.date_time.strftime('%d/%m/%Y %H:%M') }}</td>
        <td>{{ appt.service.name }}</td>
        <td>{{ appt.pet.name }}</td>
        <td>{{ appt.status }}</td>
      </tr>
    {% else %}
      <tr><td colspan="4" class="text-center">Nenhum agendamento encontrado.</td></tr>
    {% endfor %}
  </tbody>
</table>

<!-- Modal -->
<div class="modal fade" id="scheduleModal" tabindex="-1">
  <div class="modal-dialog">
    <form method="POST" action="{{ url_for('appointments') }}">
      {{ form.hidden_tag() }}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Novo Agendamento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <!-- DateTime Picker -->
          <label class="form-label">{{ form.date_time.label.text }}</label>
          <div class="input-group date" id="datetimepicker1">
            {{ form.date_time(class="form-control", placeholder="yyyy-mm-dd HH:MM") }}
            <span class="input-group-text"><i class="bi bi-calendar-date"></i></span>
          </div>

          <!-- Service Select -->
          <label class="form-label mt-3">{{ form.service.label.text }}</label>
          {{ form.service(class="form-select") }}

          <!-- Cliente Select -->
          <label class="form-label mt-3">Cliente</label>
          <select id="customerSelect" class="form-select" name="customer_id">
            {% for c in customers %}
              <option value="{{ c.id }}">{{ c.name }}</option>
            {% endfor %}
          </select>

          <!-- Pet Select (dinâmico) -->
          <label class="form-label mt-3">{{ form.pet.label.text }}</label>
          <select id="petSelect" class="form-select" name="pet">
            <option value="">Selecione primeiro o cliente</option>
          </select>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
          {{ form.submit(class="btn btn-primary") }}
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-datetimepicker@latest/js/bootstrap-datetimepicker.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-datetimepicker@latest/css/bootstrap-datetimepicker.min.css" rel="stylesheet">
<script>
$(function(){
  $('#datetimepicker1').datetimepicker({ format: 'YYYY-MM-DD HH:mm' });
});

    // Data: lista de pets por cliente
    const petsByCustomer = {
    {% for c, pets in pets_dict.items() %}
        {{ c }}: [
        {% for pet in pets %}
            {id: {{ pet.id }}, name: "{{ pet.name }}"},
        {% endfor %}
        ],
    {% endfor %}
    };

    $('#customerSelect').on('change', function(){
    const custId = this.value;
    const pets = petsByCustomer[custId] || [];
    const petSelect = $('#petSelect');
    petSelect.empty();
    pets.forEach(p => petSelect.append(new Option(p.name, p.id)));
    });
</script>
{% endblock %}