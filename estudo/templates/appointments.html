{% extends 'base.html' %}
{% block title %}Agendamentos{% endblock %}
{% block content %}
<h2>Meus Agendamentos</h2>
<button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#scheduleModal">
  Novo Agendamento
</button>
<table class="table">
  <thead><tr><th>Data/Hora</th><th>Serviço</th><th>Pet</th><th>Preço</th><th>Status</th></tr></thead>
  <tbody>
    {% for appt in appointments %}
      <tr>
        <td>{{ appt.date_time.strftime('%d/%m/%Y %H:%M') }}</td>
        <td>{{ appt.service_name }}</td>
        <td>{{ appt.pet_name }}</td>
        <td>R$ {{ "%.2f"|format(appt.price) }}</td>
        <td>{{ appt.status }}</td>
      </tr>
    {% else %}
      <tr><td colspan="5" class="text-center">Nenhum agendamento encontrado.</td></tr>
    {% endfor %}
  </tbody>
</table>

<script type="application/json" id="pets-data">{{ pets_dict|tojson }}</script>

<div class="modal fade" id="scheduleModal" tabindex="-1">
  <div class="modal-dialog">
    <form method="POST" action="{{ url_for('appointments') }}">
      {{ form.hidden_tag() }}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Novo Agendamento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          {% if form.errors %}
          <div class="alert alert-danger">
            <ul>
              {% for f, errs in form.errors.items() %}
                {% for err in errs %}
                  <li><strong>{{ form[f].label.text }}:</strong> {{ err }}</li>
                {% endfor %}
              {% endfor %}
            </ul>
          </div>
          {% endif %}
          <label>{{ form.date_time.label.text }}</label>
          <div id="dtpicker" class="input-group mb-3">
            {{ form.date_time(class="form-control", placeholder="YYYY-MM-DD HH:mm", id="dateTimeInput") }}
            <span class="input-group-text"><i class="bi bi-calendar-date"></i></span>
          </div>
          <div class="mb-3">
            {{ form.service_name.label }}{{ form.service_name(class="form-control") }}
          </div>
          <div class="mb-3">
            {{ form.price.label }}{{ form.price(class="form-control") }}
          </div>
          <div class="mb-3">
            {{ form.customer_id.label }}{{ form.customer_id(class="form-select", id="customerSelect") }}
          </div>
          <div class="mb-3">
            {{ form.pet.label }}{{ form.pet(class="form-select", id="petSelect") }}
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
          {{ form.submit(class="btn btn-primary") }}
        </div>
      </div>
    </form>
  </div>
</div>
{% endblock %}
{% block scripts %}
  {{ super() }}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@eonasdan/tempus-dominus@6.9.4/dist/css/tempus-dominus.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@eonasdan/tempus-dominus@6.9.4/dist/js/tempus-dominus.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.inputmask/5.0.8/jquery.inputmask.min.js"></script>
  <script src="{{ url_for('static', filename='js/appointments.js') }}"></script>
{% endblock %}
